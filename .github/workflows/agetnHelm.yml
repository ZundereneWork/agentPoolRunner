# This is a basic workflow to help you get started with Actions

name: Deploy_Agent

# Controls when the workflow will run
on: [push, workflow_dispatch]

jobs:
  deploymenAgentHelm:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@main
      
      - name: 'Login via Azure CLI'
        uses:  azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Helm chart
        run: |
          cd ./ghrhelm
          helm package .
          
      - name: AKS set context
        uses: azure/aks-set-context@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          resource-group: ${{ vars.RESOURCE_GROUP }}
          cluster-name: ${{ vars.CLUSTER_NAME }}
          
      - name: Deploy via Helm
        run: |
          cd ./ghrhelm
          if helm status agentrunner -n agentrunnerpool; then
            helm upgrade agentrunner  -n agentrunnerpool ghr-0.0.1.tgz --set ghr.github_token=${{ secrets.TOKEN }} --reset-values 
          else 
            helm install agentrunner -n agentrunnerpool  ghr-0.0.1.tgz  --set image.repository=gitacrwest001.azurecr.io/agentrunner --set image.tag=latest --set ghr.github_token=${{ secrets.TOKEN }} --set ghr.repo_owner=ZundereneWork 
          fi

       
